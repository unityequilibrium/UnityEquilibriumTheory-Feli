<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UET Harness Dashboard</title>
    <style>:root {
    --bg-dark: #0a0c10;
    --panel-bg: rgba(20, 25, 35, 0.7);
    --accent-primary: #4f46e5;
    --accent-secondary: #06b6d4;
    --text-main: #e2e8f0;
    --text-dim: #94a3b8;
    --border-color: rgba(255, 255, 255, 0.1);
    --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    --success: #10b981;
    --warning: #f59e0b;
    --error: #ef4444;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    background-color: var(--bg-dark);
    color: var(--text-main);
    font-family: 'Inter', sans-serif;
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.dark-theme {
    background: radial-gradient(circle at top right, #1e1b4b, #0a0c10);
}

/* Glassmorphism */
.glass {
    background: var(--panel-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--border-color);
    box-shadow: var(--glass-shadow);
}

/* Header */
.glass-header {
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 2rem;
    background: rgba(10, 12, 16, 0.8);
    backdrop-filter: blur(8px);
    z-index: 100;
    border-bottom: 1px solid var(--border-color);
}

.logo {
    font-family: 'Outfit', sans-serif;
    font-weight: 800;
    font-size: 1.4rem;
    letter-spacing: 1px;
}

.accent-text {
    background: linear-gradient(to right, var(--accent-primary), var(--accent-secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.version {
    font-size: 0.7rem;
    opacity: 0.5;
    font-weight: 300;
}

.run-info {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    font-size: 0.9rem;
}

.run-id-label {
    opacity: 0.6;
    font-weight: 600;
}

.status-badge {
    padding: 2px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    background: rgba(255, 255, 255, 0.1);
}

.status-PASS { color: var(--success); background: rgba(16, 185, 129, 0.1); }
.status-FAIL { color: var(--error); background: rgba(239, 68, 68, 0.1); }
.status-WARN { color: var(--warning); background: rgba(245, 158, 11, 0.1); }

/* Dashboard Layout */
.dashboard-layout {
    flex: 1;
    display: grid;
    grid-template-columns: 320px 1fr 320px;
    gap: 1.5rem;
    padding: 1.5rem;
    overflow: hidden;
}

.left-panel, .right-panel {
    border-radius: 16px;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

h2 {
    font-size: 1.1rem;
    font-family: 'Outfit', sans-serif;
    font-weight: 700;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 0.5rem;
}

.scroll-v {
    flex: 1;
    overflow-y: auto;
    padding-right: 5px;
}

.scroll-v::-webkit-scrollbar {
    width: 4px;
}

.scroll-v::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
}

/* Center HUD */
.center-hud {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    overflow: hidden;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
}

.metric-card {
    padding: 1.2rem;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-color);
    transition: transform 0.2s, box-shadow 0.2s;
}

.metric-card:hover {
    transform: translateY(-2px);
    background: rgba(255, 255, 255, 0.06);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.metric-label {
    display: block;
    font-size: 0.75rem;
    color: var(--text-dim);
    margin-bottom: 0.4rem;
}

.metric-value {
    font-size: 1.5rem;
    font-weight: 700;
    font-family: 'Outfit', sans-serif;
}

.metric-unit {
    font-size: 0.8rem;
    opacity: 0.5;
    margin-left: 0.3rem;
}

.graph-dock {
    flex: 1;
    border-radius: 16px;
    padding: 1.5rem;
    position: relative;
    min-height: 300px;
}

/* Config & Gates Details */
.config-item {
    margin-bottom: 0.8rem;
    font-size: 0.9rem;
}

.config-key {
    color: var(--text-dim);
    font-weight: 600;
}

.gate-item {
    padding: 1rem;
    border-radius: 10px;
    background: rgba(0, 0, 0, 0.2);
    margin-bottom: 0.8rem;
    border-left: 4px solid var(--text-dim);
}

.gate-PASS { border-left-color: var(--success); }
.gate-FAIL { border-left-color: var(--error); }
.gate-WARN { border-left-color: var(--warning); }

.gate-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.4rem;
    font-weight: 700;
}

.gate-msg {
    font-size: 0.8rem;
    line-height: 1.4;
    opacity: 0.8;
}

/* Buttons */
.btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: none;
    font-family: inherit;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.primary {
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    color: white;
}

.primary:hover {
    filter: brightness(1.2);
    box-shadow: 0 0 15px rgba(79, 70, 229, 0.4);
}

.secondary {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-main);
}

.secondary:hover {
    background: rgba(255, 255, 255, 0.2);
}

/* Modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.hidden { display: none; }

.modal-content {
    width: 500px;
    padding: 2.5rem;
    border-radius: 20px;
}

.modal-content h3 {
    margin-bottom: 1rem;
    font-family: 'Outfit', sans-serif;
}

input[type="text"] {
    width: 100%;
    padding: 12px;
    background: rgba(10, 12, 16, 0.5);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: white;
    margin: 1.5rem 0;
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}

/* Footer */
.glass-footer {
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 2rem;
    font-size: 0.75rem;
    color: var(--text-dim);
    border-top: 1px solid var(--border-color);
}

.social-links {
    display: flex;
    gap: 1.5rem;
}

.link:hover {
    color: var(--accent-secondary);
}

/* Placeholder */
.placeholder {
    opacity: 0.4;
    text-align: center;
    margin-top: 2rem;
    font-style: italic;
}
</style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Outfit:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<body class="dark-theme">
    <div id="app">
        <header class="glass-header">
            <div class="logo">
                <span class="accent-text">UET</span> HARNESS <small class="version">v0.1</small>
            </div>
            <div class="run-info" id="run-header">
                <span class="run-id-label">RUN:</span> <span id="current-run-id">Loading...</span>
                <span class="status-badge" id="overall-status">N/A</span>
            </div>
            <nav>
                <button id="load-run-btn" class="btn secondary">Load Run</button>
                <button id="refresh-btn" class="btn primary">Refresh</button>
            </nav>
        </header>

        <main class="dashboard-layout">
            <aside class="left-panel glass">
                <h2>Simulation Config</h2>
                <div id="config-content" class="scroll-v">
                    <!-- Config details injected here -->
                    <p class="placeholder">Select a run directory to view configuration.</p>
                </div>
            </aside>

            <section class="center-hud">
                <div class="metrics-grid" id="metrics-container">
                    <!-- MetricCards injected here -->
                </div>
                <div class="graph-dock glass" id="graph-container">
                    <canvas id="omega-chart"></canvas>
                </div>
            </section>

            <aside class="right-panel glass">
                <h2>Validation Gates</h2>
                <div id="gates-content" class="scroll-v">
                    <!-- GateResults injected here -->
                    <p class="placeholder">Gates output will appear after validation.</p>
                </div>
            </aside>
        </main>

        <footer class="glass-footer">
            <div class="system-stats">
                <span>Model: <b id="model-label">-</b></span>
                <span>Runtime: <b id="runtime-label">-</b></span>
            </div>
            <div class="social-links">
                <a href="#" class="link">Docs</a>
                <a href="#" class="link">Theory</a>
            </div>
        </footer>
    </div>

    <!-- Modals -->
    <div id="load-modal" class="modal hidden">
        <div class="modal-content glass">
            <h3>Load Run Data</h3>
            <p>Paste the absolute path to your run directory:</p>
            <input type="text" id="run-path-input" placeholder="C:\...\runs\model\case\id">
            <div class="modal-actions">
                <button id="modal-cancel" class="btn secondary">Cancel</button>
                <button id="modal-load" class="btn primary">Load</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="js/app.js"></script>

    <script>
        window.UET_STATIC_DATA = {"config": null, "metrics": {"Omega0": {"value": 123.45, "unit": "sim", "label": "\u03a9\u2080"}, "OmegaT": {"value": 98.76, "unit": "sim", "label": "\u03a9_T"}, "dt": {"value": 0.01, "unit": "s", "label": "\u0394t"}, "energy": {"value": 5.32, "unit": "sim", "label": "E"}}, "summary": null, "gates": null, "timeseries": null};
    </script>
    <script>
        /**
 * main app.js - UET Harness UI Logic
 * Handles data fetching from run directories and triggers component updates.
 */

class UETDashboard {
    constructor() {
        this.currentRunDir = null;
        this.config = null;
        this.metrics = null;
        this.summary = null;
        this.gates = null;
        this.timeseries = null;
        this.chart = null;


        this.initEventListeners();

        // Auto-load if static data is present
        if (window.UET_STATIC_DATA) {
            this.loadRunData(null);
        }
    }

    initEventListeners() {
        document.getElementById('load-run-btn').addEventListener('click', () => this.toggleModal(true));
        document.getElementById('refresh-btn').addEventListener('click', () => this.reloadCurrentRun());
        document.getElementById('modal-cancel').addEventListener('click', () => this.toggleModal(false));
        document.getElementById('modal-load').addEventListener('click', () => this.handleLoadClick());
        document.getElementById('run-path-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.handleLoadClick();
        });
    }

    toggleModal(show) {
        document.getElementById('load-modal').classList.toggle('hidden', !show);
        if (show) document.getElementById('run-path-input').focus();
    }

    handleLoadClick() {
        const path = document.getElementById('run-path-input').value.trim();
        if (path) {
            this.loadRunData(path);
            this.toggleModal(false);
        }
    }

    async reloadCurrentRun() {
        if (this.currentRunDir) {
            await this.loadRunData(this.currentRunDir);
        }
    }

    async loadRunData(runDir) {
        console.log(`Attempting to load run from: ${runDir}`);
        this.currentRunDir = runDir;

        // STATIC MODE: Check if data is already injected (for server-free reports)
        if (window.UET_STATIC_DATA) {
            console.log("Loading from STATIC DATA");
            const data = window.UET_STATIC_DATA;
            this.config = data.config;
            this.metrics = data.metrics;
            this.summary = data.summary;
            this.gates = data.gates;
            this.timeseries = this.parseCSV(data.timeseries);
            this.renderAll();
            return;
        }

        // DYNAMIC MODE: Fetch from server/file
        // unless opened with --allow-file-access-from-files or served via python -m http.server
        try {
            // Standardise path for fetch (handle Windows backslashes)
            const basePath = runDir.replace(/\\/g, '/');

            // Parallel fetch of all artifacts
            const [cfgRes, metRes, sumRes, gateRes, tsRes] = await Promise.all([
                fetch(`${basePath}/config.json`).then(r => r.ok ? r.json() : null).catch(() => null),
                fetch(`${basePath}/metrics.json`).then(r => r.ok ? r.json() : null).catch(() => null),
                fetch(`${basePath}/summary.json`).then(r => r.ok ? r.json() : null).catch(() => null),
                fetch(`${basePath}/gate_report.json`).then(r => r.ok ? r.json() : null).catch(() => null),
                fetch(`${basePath}/timeseries.csv`).then(r => r.ok ? r.text() : null).catch(() => null)
            ]);

            this.config = cfgRes;
            this.metrics = metRes;
            this.summary = sumRes;
            this.gates = gateRes;
            this.timeseries = this.parseCSV(tsRes);

            this.renderAll();
        } catch (err) {
            console.error("Failed to load artifacts:", err);
            alert("Failed to load run data. Check console for details. (Note: browser CORS may block local file access without a server)");
        }
    }

    parseCSV(csvText) {
        if (!csvText) return null;
        const lines = csvText.trim().split('\n');
        const headers = lines[0].split(',');
        return lines.slice(1).map(line => {
            const vals = line.split(',');
            const obj = {};
            headers.forEach((h, i) => {
                obj[h.trim()] = parseFloat(vals[i]);
            });
            return obj;
        });
    }

    renderAll() {
        this.renderHeader();
        this.renderConfig();
        this.renderMetrics();
        this.renderGates();
        this.renderChart();
        this.renderFooter();
    }

    renderHeader() {
        const runId = this.summary?.run_id || this.config?.run_id || "Unknown";
        document.getElementById('current-run-id').textContent = runId.substring(0, 12) + (runId.length > 12 ? '...' : '');

        const status = (this.summary?.status || "N/A").toUpperCase();
        const badge = document.getElementById('overall-status');
        badge.textContent = status;
        badge.className = `status-badge status-${status}`;
    }

    renderConfig() {
        const container = document.getElementById('config-content');
        if (!this.config) {
            container.innerHTML = '<p class="placeholder">Config not found.</p>';
            return;
        }

        let html = '';
        const sections = [
            { label: 'Model', val: this.config.model },
            { label: 'Grid', val: `${this.config.grid.N}x${this.config.grid.N}` },
            { label: 'Domain', val: `L=${this.config.domain.L}` },
            { label: 'Time Step', val: this.config.time.dt },
            { label: 'Steps', val: this.config.time.max_steps },
            { label: 'Integrator', val: this.config.integrator.name }
        ];

        sections.forEach(s => {
            html += `
                <div class="config-item">
                    <span class="config-key">${s.label}:</span>
                    <span class="config-val">${s.val}</span>
                </div>
            `;
        });

        // Add params if available
        if (this.config.params) {
            html += '<h3 style="font-size: 0.9rem; margin-top: 1rem; opacity: 0.7;">Parameters</h3>';
            for (const [k, v] of Object.entries(this.config.params)) {
                if (typeof v === 'object') {
                    html += `<div class="config-item"><span class="config-key">${k}:</span> <span class="config-val">${JSON.stringify(v)}</span></div>`;
                } else {
                    html += `<div class="config-item"><span class="config-key">${k}:</span> <span class="config-val">${v}</span></div>`;
                }
            }
        }

        container.innerHTML = html;
    }

    renderMetrics() {
        const container = document.getElementById('metrics-container');
        if (!this.metrics) {
            container.innerHTML = '<p class="placeholder">No metrics recorded.</p>';
            return;
        }

        let html = '';
        for (const [key, data] of Object.entries(this.metrics)) {
            html += `
                <div class="metric-card">
                    <span class="metric-label">${data.label || key}</span>
                    <div class="metric-body">
                        <span class="metric-value">${typeof data.value === 'number' ? data.value.toFixed(4) : data.value}</span>
                        <span class="metric-unit">${data.unit || ''}</span>
                    </div>
                </div>
            `;
        }
        container.innerHTML = html;
    }

    renderGates() {
        const container = document.getElementById('gates-content');
        if (!this.gates || !this.gates.gates) {
            container.innerHTML = '<p class="placeholder">No gate reports found.</p>';
            return;
        }

        let html = '';
        this.gates.gates.forEach(gate => {
            html += `
                <div class="gate-item gate-${gate.status}">
                    <div class="gate-header">
                        <span>${gate.id}</span>
                        <span class="status-badge status-${gate.status}">${gate.status}</span>
                    </div>
                    <div class="gate-msg">${gate.message}</div>
                    <div class="gate-meta" style="font-size: 0.7rem; opacity: 0.5; margin-top: 0.5rem">
                        val: ${gate.value.toFixed(6)} | tol: ${gate.tolerance}
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    renderChart() {
        const ctx = document.getElementById('omega-chart').getContext('2d');
        if (!this.timeseries) return;

        if (this.chart) this.chart.destroy();

        const labels = this.timeseries.map(d => d.t);
        const data = this.timeseries.map(d => d.Omega);

        this.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Omega (Energy)',
                    data: data,
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                scales: {
                    x: {
                        display: true,
                        title: { display: true, text: 'Time (t)', color: '#94a3b8' },
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        ticks: { color: '#94a3b8' }
                    },
                    y: {
                        display: true,
                        title: { display: true, text: 'Î©', color: '#94a3b8' },
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        ticks: { color: '#94a3b8' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    renderFooter() {
        document.getElementById('model-label').textContent = this.config?.model || "-";
        document.getElementById('runtime-label').textContent = this.summary?.runtime_s ? `${this.summary.runtime_s.toFixed(3)}s` : "-";
    }
}

// Start app
window.addEventListener('DOMContentLoaded', () => {
    window.app = new UETDashboard();
});

    </script>
    </body>
</html>
