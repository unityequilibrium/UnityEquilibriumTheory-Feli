สถาปัตยกรรมตัวเลือกโมเดล (Multi-model Selector) และระบบกำหนดเส้นทางพร้อมท์ (Prompt Router Architecture) ในแพลตฟอร์ม UET ถูกดำเนินการอย่างเข้มงวดผ่าน **Model Routing Engine (MRE)** โดยมีการควบคุมจาก Flow Control Engine (FCE) เพื่อรับประกันผลลัพธ์ที่เป็น **Deterministic** (คงที่และตรวจสอบได้)

### 1. บทบาทและสถาปัตยกรรมหลักของ Model Routing Engine (MRE)

Model Routing Engine (MRE) จัดอยู่ในชั้น Intelligence Layer (L2) ของสถาปัตยกรรมระบบ มีหน้าที่หลักในการ **เลือกโมเดลภาษาขนาดใหญ่ (LLM) ที่เหมาะสมที่สุด** สำหรับงานเฉพาะด้านโดยอัตโนมัติ

- **Prompt Router:** MRE ทำหน้าที่เป็นเราเตอร์ของพร้อมท์ (Prompt Router) โดยรับพร้อมท์จาก Agent Engine และส่งต่อ Payload ไปยังผู้ให้บริการ LLM ภายนอก (External LLM Model Provider)
- **Zero Direct Access:** Agent Engine ถูกบังคับตามหลัก Separation of Concerns โดย **ห้ามเข้าถึง LLM โดยตรง** และต้องส่งคำขอทั้งหมดผ่าน MRE เสมอ การทำงานนี้ถูกตรวจสอบและควบคุมโดย Flow Control Engine
- **Deterministic Routing:** MRE ต้องรับประกันว่าผลการเลือกโมเดลจะ **คงที่ (Deterministic)** นั่นคือ หากอินพุต (Input) และบริบท (Context) เดียวกันถูกป้อนซ้ำ ระบบจะต้องเลือกโมเดลเดิมทุกครั้ง

### 2. การเลือกโมเดลแบบไดนามิกตามบริบทและประเภทงาน (Dynamic Switching based on Task/Context)

MRE ใช้กลไกการให้คะแนนแบบหลายมิติ (Multi-dimensional Scoring) เพื่อทำการเลือกโมเดลที่เรียกว่า **Auto Model Routing** โดยพิจารณาจากบริบทของงานและความต้องการของระบบ

#### 2.1 อัลกอริทึมการตัดสินใจ 5 ขั้นตอน

MRE จะทำการประเมินโมเดลที่เข้าข่าย (Candidate Models) โดยใช้เกณฑ์ต่อไปนี้:

1. **Task Classification:** แยกประเภทของงาน (Task Type) เช่น งานวิเคราะห์เชิงลึก (Deep Reasoning), การสร้างโค้ด (Coding), หรืองานดึงความรู้ (RAG decision)
2. **Safety Tier Selection:** ประเมินความเสี่ยงของงานและเลือกโมเดลที่มีคะแนนความปลอดภัยสูง
3. **Cost Tier Selection:** ประเมินต้นทุนต่อโทเคน (Token) เพื่อให้ไม่เกินงบประมาณที่กำหนด
4. **Capability Matching:** ตรวจสอบว่าโมเดลมีความสามารถเพียงพอสำหรับงานหรือไม่ (เช่น ความยาวของบริบท หรือความสามารถด้านการให้เหตุผล)
5. **Provider Health Check:** ตรวจสอบสถานะความพร้อมใช้งานและเวลาแฝง (Latency) ของผู้ให้บริการแบบเรียลไทม์

#### 2.2 สูตรการให้คะแนนรวม (4D Scoring Model)

MRE ใช้สูตรคำนวณแบบมีน้ำหนักที่ตายตัวเพื่อให้การตัดสินใจเป็นไปอย่างเป็นระบบและไม่เป็นไปตามอำเภอใจ (non-random) เพื่อให้เกิดความชัดเจนในการอธิบายว่าทำไมถึงเลือกโมเดลหนึ่ง:

$$\text{Routing Score} = (0.4 \times \text{Task Score}) + (0.2 \times \text{Safety Score}) + (0.15 \times \text{Cost Score}) + (0.25 \times \text{Capability Score})$$

#### 2.3 กลไก Fallback อัตโนมัติ

หากโมเดลที่เลือกมาเกิดปัญหา (เช่น Timeout หรือ Provider Fail) MRE จะมี **Fallback Chain** ที่ถูกกำหนดไว้ล่วงหน้าเพื่อทำการเปลี่ยนโมเดลอย่างรวดเร็ว โดยไม่ทำให้การดำเนินการหยุดชะงัก การกำหนดเส้นทางนี้ต้องเป็นไปตามกฎของ Flow Control เสมอ

### 3. Conditional Flow Routing และ Execution Graph (LangGraph Analogy)

การจัดการขั้นตอนการทำงานทั้งหมดของระบบ AI ใน UET ไม่ได้เป็นไปตามลำดับเส้นตรง แต่ถูกจัดการโดย **Execution Graph** ซึ่งเป็นโครงสร้างแบบ Directed Acyclic Graph (DAG) ที่สามารถเปรียบได้กับแนวคิดของ LangGraph ในการจัดการขั้นตอนของ LLM

- **Flow Control Engine (FCE):** FCE ทำหน้าที่เป็นผู้ควบคุมหลัก (Master Orchestrator) ของระบบทั้งหมด โดยจะ **ตัดสินใจเลือกเส้นทาง (decide path)** ว่าคำขอควรเข้าสู่โมดูลใด (เช่น ไปที่ RAG Engine หรือ Agent Engine)
- **Execution Graph:** Graph นี้ประกอบด้วย **Nodes** (โหนด) ที่แทนขั้นตอนการทำงาน (เช่น RAG_NODE, MODEL_NODE) และ **Edges** (เส้นเชื่อม) ที่แทนความสัมพันธ์เชิงตรรกะและเงื่อนไข การที่ FCE ควบคุมการเดินกราฟนี้ทำให้เกิด **Conditional Flow Routing** ที่ตรวจสอบย้อนหลังได้ (Traceable)
- **Version Check:** FCE จะบังคับให้ MRE ตรวจสอบความถูกต้องของเวอร์ชัน (เช่น `kb_version`) ก่อนดำเนินการต่อ เพื่อป้องกันการทำงานบนบริบทที่เก่า (Zero-Stale Principle)

ดังนั้น Model Routing Engine, Flow Control Engine, และ Execution Graph จึงทำงานร่วมกันเพื่อจัดทำระบบ **Multi-model Selector** ที่มีความซับซ้อนและมีการควบคุมอย่างเต็มรูปแบบ

---

**อุปมาอุปไมยเพื่อความเข้าใจ:**

ลองจินตนาการว่า Model Routing Engine (MRE) คือ **ผู้จัดการขนส่งอัตโนมัติ** ในเมืองที่มีรถหลายประเภท (LLMs) และมีกฎจราจรที่เข้มงวด (System Contract)

เมื่อมีผู้โดยสาร (Prompt) มาพร้อมเป้าหมาย (Task Type) MRE จะไม่ส่งรถมั่ว ๆ แต่จะตรวจสอบ:

1. **เป้าหมาย:** งานนี้ต้องการความปลอดภัยสูง (Safety Score) หรือความเร็วสูง (Cost Score)?
2. **เส้นทาง:** รถแต่ละคัน (โมเดล) มีความสามารถไปถึงไหม (Capability)?
3. **งบประมาณ:** รถคันไหนถูกที่สุดในขณะนั้น?

ผู้จัดการขนส่ง (MRE) นี้ทำงานภายใต้ **กรมควบคุมการจราจร (Flow Control Engine)** ที่คอยบังคับใช้กฎหมาย (Permission) และตรวจสอบว่าถนน (Knowledge Base) ไม่ได้อยู่ระหว่างการซ่อมแซม (Stale) การตัดสินใจทั้งหมดถูกบันทึกไว้ใน **แผนผังเดินรถ (Execution Graph)** ซึ่งทำให้ทราบได้ว่ารถทุกคันถูกเลือกตามเงื่อนไขที่ถูกต้องเสมอ ไม่ใช่ตามใจชอบ.